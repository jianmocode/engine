/*!
* XpmSE UI - v1.5.7 - Auto-compiled on 2019-01-26 - Copyright 2019 
* @author Xpmse.com
*/jQuery.fn.webtable=function(a){function b(a,b){return new c(a,b)}function c(a,b){var c=this;this.option=b||[],this.em=a,this.colHeaders={},this.columns=[],this.columnsMap={},this.data=[],this.needsave=!1,this.submitLock=!1,this.getdataLock=!1,this.changelogs={create:{},update:{},remove:{}},this.removeTemp={},this.handsontableSetting={},this.renderer={unikey:function(a,b,c,d,e,f,g){return b}};var d={readOnly:!0,stretchH:"all",minRows:40,minCols:15,currentRowClassName:"currentRow",currentColClassName:"currentCol",search:{searchResultClass:"htSearchResult"},colWidths:140,rowHeights:23,rowHeaders:!0,offsetHeight:0,contextOption:{submit:!0},submitOption:{},needSubmit:function(a){},beforeSubmit:function(a,b){},afterSubmit:function(a,b,c){},beforeGetdata:function(a){},afterGetdata:function(a,b,c){},afterUnlock:function(){},afterLock:function(){},contextMenu:{callback:function(a,b){},items:{row_above:{name:"插入行",disabled:function(){if(c.isLocked())return!0}},remove_row:{name:"删除行",disabled:function(){if(c.isLocked())return!0}}}},afterChange:function(a,b){return a},beforeRemoveRow:function(a,b){return!0},afterRemoveRow:function(a,b){return!0}};this.handsontable=function(){return this.hot},this.getUnikeyCell=function(a){var b=parseInt(c.columnsMap["{{unikey}}"]),d=c.hot.getDataAtRow(a),e=d[b]||null;return e},this.setUnikeyCell=function(a,b){b=b||null;var d=parseInt(c.columnsMap["{{unikey}}"]);c.hot.setDataAtCell(a,d,b,"silent")},this.getUnikeyColumn=function(){var a=parseInt(c.columnsMap["{{unikey}}"]);return c.columns[a]},this.getData=function(a,b,d){if(!c.getdataLock){var e={type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:b||function(a,b,c){return a},error:d||function(a,b,c){}};"string"==typeof a&&(a={url:a}),a=$.extend({},e,a);var f=a.error;a.error=function(a,b,d){c.getdataLock=!1,"function"==typeof c.handsontableSetting.afterGetdata&&c.handsontableSetting.afterGetdata(d,b,a),f(a,b,d)};var b=a.success;a.success=function(a,d,e){var a=b(a,d,e);a!==!1&&"undefined"!=typeof a&&("object"==typeof a.columns&&c.setColumns(a.columns),"object"==typeof a.colHeaders&&c.hot.updateSettings({colHeaders:a.colHeaders}),"object"==typeof a.data&&c.setData(a.data),c.getdataLock=!1,"function"==typeof c.handsontableSetting.afterGetdata&&c.handsontableSetting.afterGetdata(a,d,e))},c.getdataLock=!0,"function"==typeof c.handsontableSetting.beforeGetdata&&c.handsontableSetting.beforeGetdata(a),$.ajax(a)}},this.arrayToObject=function(a){var b={};for(var d in a){var e=c.columns[d].data||"";""==e&&(e=c.columns[d].name||""),b[e]=a[d]}return b},this.submitData=function(a,b,d){if(!c.needsave||c.submitLock)return debug.log("WebTable submitData that.needsave=",c.needsave," that.submitLock=",c.submitLock),!1;var e={create:[],update:[],remove:[]},f=c.getChanges();for(var g in f.update){var h=f.update[g];e.update.push({data:c.arrayToObject(h.data),unikey:h.unikey,row:h.row})}for(var g in f.create){var h=f.create[g];e.create.push({data:c.arrayToObject(h.data),row:h.row})}for(var i in f.remove){var j=f.remove[i];e.remove.push({unikey:j.unikey,value:j.value,row:j.row})}"object"==typeof a&&null!=typeof a&&"object"==typeof a.data&&(e=$.extend({},e,a.data),delete a.data);var k=JSON.stringify(e);"object"==typeof a&&null!=typeof a&&a.escape===!0&&(k=escape(k));var l={type:"POST",dataType:"json",data:"data="+k,contentType:"application/x-www-form-urlencoded; charset=utf-8",success:b||function(a,b,c){return a},error:d||function(a,b,c){}};"string"==typeof a&&(a={url:a}),a=$.extend({},l,c.handsontableSetting.submitOption,a);var m=a.error;a.error=function(a,b,d){c.submitLock=!1,c.unlock(),"function"==typeof c.handsontableSetting.afterSubmit&&c.handsontableSetting.afterSubmit(d,b,a),m(a,b,d)};var b=a.success;a.success=function(d,e,f){var d=b(d,e,f);if(d!==!1&&"undefined"!=typeof d){if(null==d)return void a.error(f,500,d);if("undefined"!=typeof d.code&&"undefined"!=d.message&&0!=d.code)return void a.error(f,500,d);if("undefined"!=typeof d.result&&"undefined"!=d.content&&d.result===!1)return void a.error(f,500,d);for(var g in d)if("string"==typeof d[g].method&&"undefined"!=typeof d[g].unikey&&"create"==d[g].method&&c.setUnikeyCell(g,d[g].unikey),"string"==typeof d[g].method&&"error"==d[g].method){var h=d[g].data||null;if("object"==typeof h)for(var i in h)console.log("field =",i,"error=",h[i]," row=",g);else console.log("error all line error=",h," row=",g,typeof h)}c.submitLock=!1,c.unlock(),c.changelogs={create:{},update:{},remove:{}},c.needsave=!1,"function"==typeof c.handsontableSetting.needSubmit&&c.handsontableSetting.needSubmit(c.needsave),"function"==typeof c.handsontableSetting.afterSubmit&&c.handsontableSetting.afterSubmit(d,e,f)}},c.submitLock=!0,c.lock(),"function"==typeof c.handsontableSetting.beforeSubmit&&c.handsontableSetting.beforeSubmit(a,c.changelogs),debug.log("WebTable submitData: ajax_option=",a),$.ajax(a)},this.needSubmit=function(a){"undefined"!=typeof a&&null!=a||(a=!1),c.needsave=a,"function"==typeof c.handsontableSetting.needSubmit&&c.handsontableSetting.needSubmit(c.needsave)},this.setData=function(a){return c.hot.updateSettings({data:a}),c.data=c.data,c.data},this.setColHeaders=function(a){return c.colHeaders=a,c.hot.updateSettings({colHeaders:a}),c.colHeaders},this.setColumns=function(a){c.columnsMap={};for(var b in a){if("string"==typeof a[b].renderer){var d=a[b].renderer.match(/\{\{(.+)\}\}/);null!=d&&(a[b].renderer=c.renderer[d[1]],c.columnsMap["{{unikey}}"]=b)}var e=a.name;c.columnsMap[e]=b}return c.columns=a,c.hot.updateSettings({columns:a}),c.columns},this.fixHeight=function(a){var b=$(document.body).outerHeight(!0);c.handsontableSetting.offsetHeight=a=a||100,c.hot.updateSettings({height:b-a})},this.refresh=function(){c.hot.updateSettings({})},this.unlock=function(){c.handsontableSetting.readOnly=!1,c.hot.updateSettings({readOnly:!1}),"function"==typeof c.handsontableSetting.afterUnlock&&c.handsontableSetting.afterUnlock()},this.lock=function(){c.handsontableSetting.readOnly=!0,c.hot.updateSettings({readOnly:!0}),"function"==typeof c.handsontableSetting.afterLock&&c.handsontableSetting.afterLock()},this.isLocked=function(){return c.handsontableSetting.readOnly},this.redo=function(){c.hot.redo()},this.undo=function(){c.hot.undo()},this.render=function(){c.hot.render()},this.search=function(a,b,d){b=b||null,d=d||null;var e=c.handsontableSetting.search;null!=b&&(e.queryMethod=b),null!=d&&(e.callback=d),c.hot.updateSettings({search:e});var f=c.hot.search.query(a);return c.hot.render(),f},this.updateChanges=function(a,b){var d=c.getUnikeyColumn();for(var e in a){var f=a[e][0],g=parseInt(c.columnsMap["{{unikey}}"]),h=c.hot.getDataAtRow(f),i=h[g]||null;if(null==i&&(i="tmp_"+Date.parse(new Date)+1e3*Math.random(),c.hot.setDataAtCell(f,g,i,"silent")),"tmp_"==i.toString().substring(0,4))c.changelogs.create[i]={data:null,row:f};else{var j=d.data||"";""==j&&(j=d.name||""),c.changelogs.update[i]={data:null,row:f,unikey:j}}c.needsave=!0,"function"==typeof c.handsontableSetting.needSubmit&&c.handsontableSetting.needSubmit(c.needsave)}},this.getChanges=function(){for(var a in c.changelogs)if("remove"!=a)for(var b in c.changelogs[a]){var d=parseInt(c.changelogs[a][b].row);if(c.hot.isEmptyRow(d))delete c.changelogs[a][b];else{var e=c.hot.getDataAtRow(d);c.changelogs[a][b].data=e}}return c.changelogs},this.handsontableSetting=$.extend({},d,b);var e=this.handsontableSetting.afterChange||function(){};this.handsontableSetting.afterChange=function(a,b){a=e(a,b),0!=a&&(null!==a&&"object"==typeof a&&"string"==typeof a.source&&"object"==typeof a.changes&&(b=a.source,a=a.changes),"edit"==b&&c.updateChanges(a,b))},this.handsontableSetting.beforePaste=function(a,b){if(!c.isLocked()&&"object"==typeof b[0]&&null!=b[0]){var d=parseInt(b[0].startRow),f=(parseInt(b[0].endRow),parseInt(b[0].startCol)),g=(parseInt(b[0].endCol),[]);for(var h in a){var i=parseInt(h),j=d+i,k=a[h];for(var l in k){var m=parseInt(l),n=f+m,o=c.hot.getDataAtCell(j,n)||"";g.push([j,n,o,k[l]])}}source="paste",g=e(g,source),0!=g&&(null!==g&&"object"==typeof g&&"string"==typeof g.source&&"object"==typeof g.changes&&(source=g.source,g=g.changes),c.updateChanges(g,source))}},this.handsontableSetting.beforeAutofill=function(a,b,d){if(!c.isLocked()){for(var f=parseInt(a.row),g=parseInt(b.row),h=parseInt(a.col),i=(parseInt(b.col),{rows:d.length,cols:d[0].length}),j=[],k=0,l=f;l<=g;l++){var m=parseInt(l),n=d[k];k++,k>=i.rows&&(k=0);for(var o in n){var p=parseInt(o),q=h+p,r=c.hot.getDataAtCell(m,q)||"";j.push([m,q,r,n[o]])}}source="autofill",j=e(j,source),0!=j&&(null!==j&&"object"==typeof j&&"string"==typeof j.source&&"object"==typeof j.changes&&(source=j.source,j=j.changes),c.updateChanges(j,source))}};var f=this.handsontableSetting.beforeRemoveRow;this.handsontableSetting.beforeRemoveRow=function(a,b){if(f(a,b)!==!1)for(var d=a+b,e=c.getUnikeyColumn(),g=a;g<d;g++)if(!c.hot.isEmptyRow(g)){var h=c.getUnikeyCell(g),i=e.data||"";""==i&&(i=e.name||""),c.removeTemp[h]={unikey:i,row:g,value:h}}};var g=this.handsontableSetting.afterRemoveRow;this.handsontableSetting.afterRemoveRow=function(a,b){if(g(a,b)!==!1){for(var d in c.removeTemp)if("tmp_"==d.substring(0,4))try{delete c.changelogs.create[d]}catch(e){}else{try{delete c.changelogs.update[d]}catch(e){}c.changelogs.remove[d]=c.removeTemp[d],c.needsave=!0,"function"==typeof c.handsontableSetting.needSubmit&&c.handsontableSetting.needSubmit(c.needsave)}c.removeTemp={}}};var h=this.handsontableSetting.afterRedo||function(){},i=this.handsontableSetting.afterUndo||function(){};if(this.handsontableSetting.afterRedo=function(a){h(a,c.hot.isRedoAvailable())},this.handsontableSetting.afterUndo=function(a){i(a,c.hot.isUndoAvailable())},1==this.handsontableSetting.contextOption.submit){var j=(this.handsontableSetting.contextMenu,this.handsontableSetting.contextMenu.callback||function(a,b){});this.handsontableSetting.contextMenu.items=this.handsontableSetting.contextMenu.items||{},"undefined"==typeof this.handsontableSetting.contextMenu.items.submit&&(this.handsontableSetting.contextMenu.items.submit={name:"保存",disabled:function(){return!c.needsave}}),this.handsontableSetting.contextMenu.callback=function(a,b){j(a,b),"submit"==a&&c.submitData()}}var k={columns:null,colHeaders:null,data:null};"object"==typeof this.handsontableSetting.columns&&(k.columns=this.handsontableSetting.columns,delete this.handsontableSetting.columns),"object"==typeof this.handsontableSetting.colHeaders&&(k.colHeaders=this.handsontableSetting.colHeaders,delete this.handsontableSetting.colHeaders),"object"==typeof this.handsontableSetting.data&&(k.data=this.handsontableSetting.data,delete this.handsontableSetting.data),$(a).handsontable(this.handsontableSetting),this.hot=$(a).handsontable("getInstance"),0!=this.handsontableSetting.offsetHeight&&this.fixHeight(this.handsontableSetting.offsetHeight),"object"==typeof k.columns&&this.setColumns(k.columns),"object"==typeof k.colHeaders&&this.setColHeaders(k.colHeaders),"object"==typeof k.data&&this.setData(k.data),delete k.data}if("handsontable"===a){if(this.length>1){var d=[];return this.each(function(){var a=$(this).data("webtable");d.push(a.handsontable())}),d}return $(this).data("webtable").handsontable()}if("get"===a){if(this.length>1){var e=[];return this.each(function(){e.push($(this).data("webtable"))}),e}return $(this).data("webtable")}this.each(function(){$(this).data("webtable",b($(this),a))})};